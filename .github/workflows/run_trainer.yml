name: Nexus Trader with Alerts

on:
  schedule:
    - cron: '*/20 * * * *'  # Every 20 minutes
  workflow_dispatch:

# Prevents overlapping runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run_trainer:
    runs-on: ubuntu-22.04
    timeout-minutes: 8
    
    permissions:
      contents: write

    steps:
      # ========== SETUP & DEBUG ==========
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Debug Webhook Status
        run: |
          echo "Checking Discord webhook configuration..."
          if [ -n "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            echo "âœ“ DISCORD_WEBHOOK secret is SET"
            # Show first/last chars (not full URL for security)
            WEBHOOK="${{ secrets.DISCORD_WEBHOOK }}"
            echo "Webhook starts with: ${WEBHOOK:0:30}..."
            echo "Webhook ends with: ...${WEBHOOK: -20}"
          else
            echo "âœ— DISCORD_WEBHOOK secret is NOT SET"
            echo "Please add DISCORD_WEBHOOK secret in repository settings"
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # ========== TEST ALERT FUNCTION ==========
      - name: Test Discord Webhook
        run: |
          echo "Testing Discord webhook connection..."
          
          # Create a simple test Python script
          cat > test_webhook.py << 'EOF'
import os
import requests
import json
import sys

def test_webhook():
    webhook_url = os.getenv('DISCORD_WEBHOOK')
    
    if not webhook_url:
        print("ERROR: DISCORD_WEBHOOK environment variable not set")
        return False
    
    print(f"Webhook URL available: {'Yes' if webhook_url else 'No'}")
    
    # Test payload
    payload = {
        "content": "ðŸ”§ Nexus Trader Test Alert",
        "embeds": [{
            "title": "GitHub Actions Test",
            "description": "If you see this, Discord alerts are working!",
            "color": 5763719,  # Green color
            "fields": [
                {"name": "Status", "value": "âœ… Test Successful", "inline": True},
                {"name": "Workflow", "value": "Nexus Trader", "inline": True}
            ]
        }]
    }
    
    try:
        response = requests.post(
            webhook_url,
            json=payload,
            timeout=10
        )
        
        if response.status_code == 204:
            print("âœ… Webhook test SUCCESS - Message sent to Discord")
            return True
        else:
            print(f"âŒ Webhook test FAILED - Status code: {response.status_code}")
            print(f"Response: {response.text}")
            return False
            
    except Exception as e:
        print(f"âŒ Webhook test ERROR: {str(e)}")
        return False

if __name__ == "__main__":
    success = test_webhook()
    sys.exit(0 if success else 1)
EOF
          
          # Run the test
          python test_webhook.py || echo "Webhook test failed, but continuing..."

      # ========== MAIN EXECUTION ==========
      - name: Run Trainer Engine with Enhanced Logging
        id: trainer
        run: |
          echo "========================================"
          echo "STARTING NEXUS TRADER - $(date)"
          echo "========================================"
          
          # Run with verbose output
          set -x  # Enable command tracing
          python trainer_daemon.py
          EXIT_CODE=$?
          set +x  # Disable command tracing
          
          echo "Trainer exit code: $EXIT_CODE"
          
          # Store exit code for later steps
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… Trainer completed successfully"
          else
            echo "âš ï¸ Trainer exited with code $EXIT_CODE"
          fi

      # ========== SEND RESULTS ALERT ==========
      - name: Send Completion Alert
        if: always()
        run: |
          echo "Sending completion alert..."
          
          cat > send_alert.py << 'EOF'
import os
import requests
import json
from datetime import datetime

# Get workflow information
workflow_name = os.getenv('GITHUB_WORKFLOW', 'Nexus Trader')
run_id = os.getenv('GITHUB_RUN_ID', 'Unknown')
repository = os.getenv('GITHUB_REPOSITORY', 'Unknown')
run_url = f"https://github.com/{repository}/actions/runs/{run_id}"
job_status = os.getenv('JOB_STATUS', 'completed')

# Get trainer exit code
exit_code = int(os.getenv('TRAINER_EXIT_CODE', '0'))

# Determine alert type
if exit_code == 0:
    color = 5763719  # Green
    status_emoji = "âœ…"
    status_text = "Success"
else:
    color = 15548997  # Red
    status_emoji = "âŒ"
    status_text = f"Failed (Exit code: {exit_code})"

# Create payload
payload = {
    "content": f"{status_emoji} Nexus Trader Workflow {status_text}",
    "embeds": [{
        "title": f"{workflow_name} - {job_status}",
        "description": f"Automated trading model update {status_text.lower()}",
        "color": color,
        "timestamp": datetime.utcnow().isoformat() + "Z",
        "fields": [
            {"name": "Repository", "value": repository, "inline": True},
            {"name": "Run ID", "value": f"#{run_id}", "inline": True},
            {"name": "Status", "value": status_text, "inline": True},
            {"name": "View Details", "value": f"[Open Workflow]({run_url})", "inline": False}
        ],
        "footer": {"text": "GitHub Actions â€¢ Nexus Trader"}
    }]
}

# Send to Discord
webhook_url = os.getenv('DISCORD_WEBHOOK')
if webhook_url:
    try:
        response = requests.post(webhook_url, json=payload, timeout=10)
        print(f"Alert sent. Status: {response.status_code}")
    except Exception as e:
        print(f"Failed to send alert: {e}")
else:
    print("No webhook URL configured")
EOF
          
          # Run the alert script
          python send_alert.py

      # ========== DATABASE SYNC ==========
      - name: Check Database Changes
        if: steps.trainer.outcome == 'success'
        run: |
          echo "Checking for database changes..."
          
          # Ensure data directory exists
          mkdir -p data
          
          # Check if database file exists
          if [ ! -f "data/trading.db" ]; then
            echo "Warning: data/trading.db not found"
            echo "changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check git status
          git status --porcelain data/trading.db 2>/dev/null > db_status.txt
          
          if [ -s db_status.txt ]; then
            echo "Database has changes:"
            cat db_status.txt
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "No changes to database"
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push Changes
        if: steps.trainer.outcome == 'success' && steps.check-db.outputs.changes == 'true'
        run: |
          echo "Committing database changes..."
          
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add only the database file
          git add data/trading.db
          
          # Create commit
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          git commit -m "ðŸ¤– Nexus Update: $(date +"%Y-%m-%d %H:%M")" \
                     -m "Automated database sync from GitHub Actions" \
                     -m "Workflow: ${{ github.workflow }} #${{ github.run_number }}"
          
          # Push changes
          git pull --rebase
          git push
          
          echo "âœ… Database synced successfully"

      # ========== FINAL STATUS ==========
      - name: Workflow Summary
        if: always()
        run: |
          echo "========================================"
          echo "WORKFLOW SUMMARY"
          echo "========================================"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: #${{ github.run_number }}"
          echo "Repository: ${{ github.repository }}"
          echo "Trigger: ${{ github.event_name }}"
          echo "Status: ${{ job.status }}"
          echo "Runner: ${{ runner.os }}"
          echo "Completed at: $(date)"
          echo "========================================"
