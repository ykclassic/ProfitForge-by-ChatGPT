name: Nexus Trainer Cycle

on:
  workflow_dispatch:
  schedule:
    # Runs at 20 minutes past every hour (UTC)
    - cron: "20 * * * *" 

jobs:
  trainer:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      contents: write # Essential for pushing the .db file back

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ensures full history for a clean push

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas ccxt scikit-learn hmmlearn requests

      - name: Initialize data directory
        run: mkdir -p data

      - name: Run Nexus Predictive Engine
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          echo "ðŸš€ Starting Predictive Cycle at $(date -u)"
          # We run the script once per trigger to ensure data is saved immediately
          python trainer_daemon.py
          echo "âœ… Cycle Complete"

      - name: Commit and Push Database
        if: always() # Ensures data is saved even if the python script has a partial error
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add data/trading.db
          # [skip ci] prevents the push from triggering a recursive loop
          git commit -m "Nexus Data Sync: $(date -u) [skip ci]" || echo "No changes to commit"
          git push origin main
